<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Bài toán Audio Classification" /><meta name="author" content="tuanio" /><meta property="og:locale" content="en" /><meta name="description" content="Nội dung 1. Bài toán Audio Classification 2. Thực nghiệm bài toán Audio Classification với bộ dữ liệu Speech Commands 2.1. Bộ dữ liệu Speech Commands 2.2. Những thành phần cần thiết của Pytorch Lightning cho bài toán 2.3. Kết quả 3. Tổng kết 4. Tham khảo" /><meta property="og:description" content="Nội dung 1. Bài toán Audio Classification 2. Thực nghiệm bài toán Audio Classification với bộ dữ liệu Speech Commands 2.1. Bộ dữ liệu Speech Commands 2.2. Những thành phần cần thiết của Pytorch Lightning cho bài toán 2.3. Kết quả 3. Tổng kết 4. Tham khảo" /><link rel="canonical" href="https://tuanio.github.io//posts/audio-classification/" /><meta property="og:url" content="https://tuanio.github.io//posts/audio-classification/" /><meta property="og:site_name" content="tuanio" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-05-05T13:55:00+07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Bài toán Audio Classification" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@tuanio" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"tuanio"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://tuanio.github.io//posts/audio-classification/"},"description":"Nội dung 1. Bài toán Audio Classification 2. Thực nghiệm bài toán Audio Classification với bộ dữ liệu Speech Commands 2.1. Bộ dữ liệu Speech Commands 2.2. Những thành phần cần thiết của Pytorch Lightning cho bài toán 2.3. Kết quả 3. Tổng kết 4. Tham khảo","url":"https://tuanio.github.io//posts/audio-classification/","@type":"BlogPosting","headline":"Bài toán Audio Classification","dateModified":"2022-08-28T19:56:09+07:00","datePublished":"2022-05-05T13:55:00+07:00","@context":"https://schema.org"}</script><title>Bài toán Audio Classification | tuanio</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="tuanio"><meta name="application-name" content="tuanio"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://deforani.sirv.com/Images/tuanio.github.io/avatar/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">tuanio</a></div><div class="site-subtitle font-italic">Một nơi để viết về những gì tôi đã học</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/tuanio" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://www.facebook.com/tuanio1211/" aria-label="facebook" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-facebook"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['nvatuan3','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/in/tuanio" aria-label="linkedin" class="order-6" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Bài toán Audio Classification</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Bài toán Audio Classification</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> tuanio </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, May 5, 2022, 1:55 PM +0700" >May 5<i class="unloaded">2022-05-05T13:55:00+07:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sun, Aug 28, 2022, 7:56 PM +0700" >Aug 28<i class="unloaded">2022-08-28T19:56:09+07:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2283 words">12 min read</span></div></div><div class="post-content"><h3 id="nội-dung">Nội dung</h3><ul><li><a href="#-bai-toan">1. Bài toán Audio Classification</a><li><a href="#-thuc-nghiem">2. Thực nghiệm bài toán Audio Classification với bộ dữ liệu Speech Commands</a><ul><li><a href="#-du-lieu">2.1. Bộ dữ liệu Speech Commands</a><li><a href="#-pytorch-lightning">2.2. Những thành phần cần thiết của Pytorch Lightning cho bài toán</a><li><a href="#-ket-qua">2.3. Kết quả</a></ul><li><a href="#-tong-ket">3. Tổng kết</a><li><a href="#-tham-khao">4. Tham khảo</a></ul><p><a name="-bai-toan"></a></p><h1 id="1-bài-toán-audio-classification">1. Bài toán Audio Classification</h1><p>Bài toán nhận diện âm thanh là một dạng bài toán phổ thông và có nhiều ứng dụng trong thực tế. Nhiệm vụ của chúng ta trong bài toán này là phân loại được các bản ghi âm thanh thành các thể loại (lớp) đã được quy định sẵn.</p><p>Đây là một bài toán phân loại bình thường, nhưng cấu trúc dữ liệu âm thanh có thể khác so với dạng ma trận có sẵn khi chúng ta làm phân lớp với mô hình Decision Tree hay Logistic Regression.</p><p>Hình dưới đây mô tả dạng tín hiệu âm thanh khi được đọc lên từ file.</p><p> <img data-proofer-ignore data-src="/assets/audio_classification/audio_signal.png" alt="audio_signal" /> <em>Hình 1: Dạng tín hiệu sóng của một file âm thanh.</em></p><p>Ta thấy dạng sóng này có dạng 1D, vậy nên ta có thể sử dụng Convolution 1D để trích xuất thông tin từ tín hiệu. Dạng mô hình M5 là một ví dụ trong trường hợp này <a href="#-reference-1">[1]</a>.</p><p>Nhưng thay vì xử lý trên dạng tín hiệu sóng thô của âm thanh, ta có thể trích xuất thông tin và chuyển tín hiệu âm thanh thành dạng ảnh để xử lý trên kiến trúc CNN 2D, tiện lợi hơn, đơn giản hơn và phổ biến hơn. Hình dưới đây mô tả dạng Mel Spectrogram sau khi chuyển từ dạng tín hiệu sóng. Ta thấy nó giống hệt một tấm ảnh.</p><p> <img data-proofer-ignore data-src="/assets/audio_classification/mel_spectrogram.jpg" alt="mel_spectrogram" /> <em>Hình 2: Dạng Mel Spectrogram của một file âm thanh.</em></p><p><strong>Các bước thực hiện bài toán nhận dạng âm thanh:</strong></p><ol><li>Chuyển dữ liệu tín hiệu âm thanh thành dạng Mel Spectrogram.<li>Sử dụng một kiến trúc CNN cho bài toán phân loại để học Mel Spectrogram được chuyển từ các file.<li>Đánh giá mô hình.</ol><p>Ta có thể sử dụng bất kì kiến trúc CNN xử lý trên ảnh 2D nào cho bài toán này. Ở đây mình sẽ sử dụng kiến trúc AlexNet <a href="#-reference-2">[2]</a> cho đơn giản. Hình dưới mô tả AlexNet cho bài toán này, nhận vào một Mel Spectrogram và xuất ra phân bố xác suất với kích cỡ là số lượng lớp của dữ liệu.</p><p> <img data-proofer-ignore data-src="/assets/audio_classification/alexnet.png" alt="alexnet" /> <em>Hình 3: Kiến trúc AlexNet trong bài toán này.</em></p><p><a name="-thuc-nghiem"></a></p><h1 id="2-thực-nghiệm-bài-toán-audio-classification-với-bộ-dữ-liệu-speech-commands">2. Thực nghiệm bài toán Audio Classification với bộ dữ liệu Speech Commands</h1><p><a name="-du-lieu"></a></p><h2 id="21-bộ-dữ-liệu-speech-commands">2.1. Bộ dữ liệu Speech Commands</h2><p>Bộ dữ liệu này chứa 35 lớp, với mỗi lớp là tập hợp những file âm thanh ghi âm giọng nói của người nói từ vựng của lớp đó. Các lớp bao gồm những từ vựng dưới đây:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre><td class="rouge-code"><pre><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">"house"</span><span class="p">,</span>
    <span class="s">"marvin"</span><span class="p">,</span>
    <span class="s">"yes"</span><span class="p">,</span>
    <span class="s">"bird"</span><span class="p">,</span>
    <span class="s">"no"</span><span class="p">,</span>
    <span class="s">"on"</span><span class="p">,</span>
    <span class="s">"off"</span><span class="p">,</span>
    <span class="s">"wow"</span><span class="p">,</span>
    <span class="s">"backward"</span><span class="p">,</span>
    <span class="s">"happy"</span><span class="p">,</span>
    <span class="s">"nine"</span><span class="p">,</span>
    <span class="s">"forward"</span><span class="p">,</span>
    <span class="s">"left"</span><span class="p">,</span>
    <span class="s">"one"</span><span class="p">,</span>
    <span class="s">"visual"</span><span class="p">,</span>
    <span class="s">"up"</span><span class="p">,</span>
    <span class="s">"learn"</span><span class="p">,</span>
    <span class="s">"five"</span><span class="p">,</span>
    <span class="s">"bed"</span><span class="p">,</span>
    <span class="s">"stop"</span><span class="p">,</span>
    <span class="s">"dog"</span><span class="p">,</span>
    <span class="s">"tree"</span><span class="p">,</span>
    <span class="s">"right"</span><span class="p">,</span>
    <span class="s">"three"</span><span class="p">,</span>
    <span class="s">"zero"</span><span class="p">,</span>
    <span class="s">"six"</span><span class="p">,</span>
    <span class="s">"two"</span><span class="p">,</span>
    <span class="s">"go"</span><span class="p">,</span>
    <span class="s">"sheila"</span><span class="p">,</span>
    <span class="s">"down"</span><span class="p">,</span>
    <span class="s">"seven"</span><span class="p">,</span>
    <span class="s">"follow"</span><span class="p">,</span>
    <span class="s">"eight"</span><span class="p">,</span>
    <span class="s">"cat"</span><span class="p">,</span>
    <span class="s">"four"</span><span class="p">,</span>
<span class="p">]</span>
</pre></table></code></div></div><p>Ta sẽ sử dụng bộ dữ liệu này từ thư viện <code class="language-plaintext highlighter-rouge">torchaudio</code> cho tiện, không mất công quản lý file.</p><p><a name="-pytorch-lightning"></a></p><h2 id="22-những-thành-phần-cần-thiết-của-pytorch-lightning-cho-bài-toán">2.2. Những thành phần cần thiết của Pytorch Lightning cho bài toán</h2><p>Đối với Pytorch thông thường, ta sẽ phải chuẩn bị dữ liệu thông qua Dataset, chia batch dữ liệu thông qua DataLoader, chuẩn bị mô hình, chuẩn bị hàm train và hàm validate, lưu lại các thông tin lúc train… . Có quá nhiều thông tin cần quản lý. Thay vào đó, bài viết này mình sẽ thực hiện bằng Pytorch Lightning để tiện quản lý các thành phần. Bạn đọc có thể tìm hiểu kỹ hơn về Pytorch Lightning ở <a href="https://www.pytorchlightning.ai/" target="_blank">đây</a>.</p><p>Trước mắt, ta sẽ cần:</p><ul><li><code class="language-plaintext highlighter-rouge">DataModule</code>: Module quản lý dữ liệu âm thanh theo batch.<li><code class="language-plaintext highlighter-rouge">ModelModule</code>: Module quản lý model, optimizer, scheduler và thao tác thực hiện của hàm train, validate và test.</ul><p>Dưới đây là code của Data Module được đặt trong file <code class="language-plaintext highlighter-rouge">datamodule.py</code>:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">labels2int</span>
<span class="kn">import</span> <span class="nn">pytorch_lightning</span> <span class="k">as</span> <span class="n">pl</span>
<span class="kn">import</span> <span class="nn">torchaudio.transforms</span> <span class="k">as</span> <span class="n">T</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>
<span class="kn">from</span> <span class="nn">torchaudio.datasets</span> <span class="kn">import</span> <span class="n">SPEECHCOMMANDS</span>
<span class="kn">from</span> <span class="nn">torch.nn.utils.rnn</span> <span class="kn">import</span> <span class="n">pad_sequence</span>


<span class="k">class</span> <span class="nc">SpeechCommandDataModule</span><span class="p">(</span><span class="n">pl</span><span class="p">.</span><span class="n">LightningDataModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">root</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">"./"</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
        <span class="n">n_fft</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
        <span class="n">pin_memory</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">()</span>
        <span class="c1"># thư mục lưu dữ liệu
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="c1"># tạo class MelSpectrogram với số lượng fast fourier transform được chỉ định sẵn
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">T</span><span class="p">.</span><span class="n">MelSpectrogram</span><span class="p">(</span><span class="n">n_fft</span><span class="p">)</span> 

        <span class="bp">self</span><span class="p">.</span><span class="n">pin_memory</span> <span class="o">=</span> <span class="n">pin_memory</span>

    <span class="k">def</span> <span class="nf">prepare_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">'''
        Hàm này để chuẩn bị dữ liệu, tải dữ liệu sẽ được tự gọi khi khởi tạo
        '''</span>
        <span class="n">SPEECHCOMMANDS</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">root</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage</span><span class="p">):</span>
        <span class="s">'''
        Hàm này chuẩn bị dữ liệu train, test, val
        '''</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">train_set</span> <span class="o">=</span> <span class="n">SPEECHCOMMANDS</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">root</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="s">"training"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">test_set</span> <span class="o">=</span> <span class="n">SPEECHCOMMANDS</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">root</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="s">"testing"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">val_set</span> <span class="o">=</span> <span class="n">SPEECHCOMMANDS</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">root</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="s">"validation"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">train_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">'''
        DataLoader của hàm train
        '''</span>
        <span class="k">return</span> <span class="n">DataLoader</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">train_set</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">collate_fn</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">__collate_fn</span><span class="p">,</span>
            <span class="n">pin_memory</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">pin_memory</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="c1"># shuffle dữ liệu để tạo sự đa dạng
</span>        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">val_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">'''
        DataLoader của hàm validate
        '''</span>
        <span class="k">return</span> <span class="n">DataLoader</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">val_set</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">collate_fn</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">__collate_fn</span><span class="p">,</span>
            <span class="n">pin_memory</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">pin_memory</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">'''
        DataLoader của hàm test
        '''</span>
        <span class="k">return</span> <span class="n">DataLoader</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">test_set</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">collate_fn</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">__collate_fn</span><span class="p">,</span>
            <span class="n">pin_memory</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">pin_memory</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__collate_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="s">'''
        Hàm này sẽ nhận vào một batch và
            chuyển các dữ liệu âm thanh thành dạng Mel Spectrogram
                pad thêm số 0 vào để kích cỡ bằng nhau
                    phục vụ cho việc nhân ma trận của mô hình.
        '''</span>
        <span class="n">mel_specs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">transform</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="n">squeeze</span><span class="p">().</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="n">labels2int</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">])</span>

        <span class="n">mel_specs</span> <span class="o">=</span> <span class="n">pad_sequence</span><span class="p">(</span><span class="n">mel_specs</span><span class="p">,</span> <span class="n">batch_first</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1"># thêm 3 channel
</span>        <span class="c1"># do mô hình alexnet yêu cầu đầu vào là một ảnh có 3 channel
</span>        <span class="c1"># nên ta sẽ xếp chồng 3 lần tấm ảnh mel spectrogram lên để có 3 channel
</span>        <span class="n">mel_specs</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">stack</span><span class="p">([</span><span class="n">mel_specs</span><span class="p">,</span> <span class="n">mel_specs</span><span class="p">,</span> <span class="n">mel_specs</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mel_specs</span><span class="p">,</span> <span class="n">labels</span>
</pre></table></code></div></div><p>Dưới đây là code Model Module của file <code class="language-plaintext highlighter-rouge">model.py</code>:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">import</span> <span class="nn">pytorch_lightning</span> <span class="k">as</span> <span class="n">pl</span>
<span class="kn">from</span> <span class="nn">torchvision.models.alexnet</span> <span class="kn">import</span> <span class="n">AlexNet</span>


<span class="k">class</span> <span class="nc">ModelModule</span><span class="p">(</span><span class="n">pl</span><span class="p">.</span><span class="n">LightningModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">num_classes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">dropout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
        <span class="n">optim_configs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">alexnet</span> <span class="o">=</span> <span class="n">AlexNet</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="n">dropout</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">lr</span> <span class="o">=</span> <span class="n">lr</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">optim_configs</span> <span class="o">=</span> <span class="n">optim_configs</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="p">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="s">'''hàm này để dự đoán'''</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">alexnet</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span><span class="p">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">configure_optimizers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># dùng adam optimizer
</span>        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">optim</span><span class="p">.</span><span class="n">Adam</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">lr</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="p">.</span><span class="n">optim_configs</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">optimizer</span>

    <span class="k">def</span> <span class="nf">training_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
        <span class="s">'''
        Hàm này nhận vào một batch
        lấy kết quả của mô hình và tính loss
        mô hình sẽ tự tính back propagation
        '''</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">batch</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">alexnet</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">functional</span><span class="p">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="c1"># lưu lại loss của train
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">"train_loss"</span><span class="p">,</span> <span class="n">loss</span><span class="p">.</span><span class="n">item</span><span class="p">())</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">"lr"</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">lr</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">loss</span>

    <span class="k">def</span> <span class="nf">validation_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
        <span class="s">'''
        Hàm này nhận vào một batch
        lấy kết quả của mô hình và tính loss
        
        '''</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">batch</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">alexnet</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">functional</span><span class="p">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="c1"># lựa chọn lớp có xác suất cao nhất để làm dự đoán
</span>        <span class="n">pred</span> <span class="o">=</span> <span class="n">out</span><span class="p">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># tính accuracy
</span>        <span class="n">acc</span> <span class="o">=</span> <span class="p">(</span><span class="n">pred</span> <span class="o">==</span> <span class="n">y</span><span class="p">).</span><span class="nb">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">y</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># lưu lại loss của validate
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">"val_loss"</span><span class="p">,</span> <span class="n">loss</span><span class="p">.</span><span class="n">item</span><span class="p">())</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">"val_acc"</span><span class="p">,</span> <span class="n">acc</span><span class="p">.</span><span class="n">item</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">acc</span>

    <span class="k">def</span> <span class="nf">test_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">batch</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">alexnet</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">functional</span><span class="p">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="c1"># lựa chọn lớp có xác suất cao nhất để làm dự đoán
</span>        <span class="n">pred</span> <span class="o">=</span> <span class="n">out</span><span class="p">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># tính accuracy
</span>        <span class="n">acc</span> <span class="o">=</span> <span class="p">(</span><span class="n">pred</span> <span class="o">==</span> <span class="n">y</span><span class="p">).</span><span class="nb">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">y</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># lưu lại loss của test
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">"test_loss"</span><span class="p">,</span> <span class="n">loss</span><span class="p">.</span><span class="n">item</span><span class="p">())</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">"test_acc"</span><span class="p">,</span> <span class="n">acc</span><span class="p">.</span><span class="n">item</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">acc</span>
</pre></table></code></div></div><p>Ta thấy các thao tác như train, test, validate, chuẩn bị dataloader, optimizer, scheduler, lưu lại loss, lưu lại accuracy được quản lý bởi hai lớp <code class="language-plaintext highlighter-rouge">SpeechCommandDataModule</code> và <code class="language-plaintext highlighter-rouge">ModelModule</code>, gọn hơn nhiều so với việc quản lý từng thành phần riêng lẻ.</p><p>Do label của chúng ta là chữ, nên ta sẽ quản lý lại thành các số, từ đó tiện cho mô hình tính toán loss.</p><p>File <code class="language-plaintext highlighter-rouge">utils.py</code>:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre><td class="rouge-code"><pre><span class="c1"># số sang label chữ
</span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">"house"</span><span class="p">,</span>
    <span class="s">"marvin"</span><span class="p">,</span>
    <span class="s">"yes"</span><span class="p">,</span>
    <span class="s">"bird"</span><span class="p">,</span>
    <span class="s">"no"</span><span class="p">,</span>
    <span class="s">"on"</span><span class="p">,</span>
    <span class="s">"off"</span><span class="p">,</span>
    <span class="s">"wow"</span><span class="p">,</span>
    <span class="s">"backward"</span><span class="p">,</span>
    <span class="s">"happy"</span><span class="p">,</span>
    <span class="s">"nine"</span><span class="p">,</span>
    <span class="s">"forward"</span><span class="p">,</span>
    <span class="s">"left"</span><span class="p">,</span>
    <span class="s">"one"</span><span class="p">,</span>
    <span class="s">"visual"</span><span class="p">,</span>
    <span class="s">"up"</span><span class="p">,</span>
    <span class="s">"learn"</span><span class="p">,</span>
    <span class="s">"five"</span><span class="p">,</span>
    <span class="s">"bed"</span><span class="p">,</span>
    <span class="s">"stop"</span><span class="p">,</span>
    <span class="s">"dog"</span><span class="p">,</span>
    <span class="s">"tree"</span><span class="p">,</span>
    <span class="s">"right"</span><span class="p">,</span>
    <span class="s">"three"</span><span class="p">,</span>
    <span class="s">"zero"</span><span class="p">,</span>
    <span class="s">"six"</span><span class="p">,</span>
    <span class="s">"two"</span><span class="p">,</span>
    <span class="s">"go"</span><span class="p">,</span>
    <span class="s">"sheila"</span><span class="p">,</span>
    <span class="s">"down"</span><span class="p">,</span>
    <span class="s">"seven"</span><span class="p">,</span>
    <span class="s">"follow"</span><span class="p">,</span>
    <span class="s">"eight"</span><span class="p">,</span>
    <span class="s">"cat"</span><span class="p">,</span>
    <span class="s">"four"</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># label chữ sang số
</span><span class="n">labels2int</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))))</span>
</pre></table></code></div></div><p>Cuối cùng, ta tập hợp tất cả lại để trong file <code class="language-plaintext highlighter-rouge">main.py</code>.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">hydra</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">from</span> <span class="nn">omegaconf</span> <span class="kn">import</span> <span class="n">OmegaConf</span><span class="p">,</span> <span class="n">DictConfig</span>
<span class="kn">from</span> <span class="nn">datamodule</span> <span class="kn">import</span> <span class="n">SpeechCommandDataModule</span>
<span class="kn">from</span> <span class="nn">model</span> <span class="kn">import</span> <span class="n">ModelModule</span>
<span class="kn">import</span> <span class="nn">pytorch_lightning</span> <span class="k">as</span> <span class="n">pl</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s">"Config path"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"-cp"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"config path"</span><span class="p">)</span>  <span class="c1"># config path
</span>    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"-cn"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"config name"</span><span class="p">)</span>  <span class="c1"># config name
</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="o">@</span><span class="n">hydra</span><span class="p">.</span><span class="n">main</span><span class="p">(</span><span class="n">config_path</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">cp</span><span class="p">,</span> <span class="n">config_name</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">cn</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">DictConfig</span><span class="p">):</span>
        <span class="n">dm</span> <span class="o">=</span> <span class="n">SpeechCommandDataModule</span><span class="p">(</span><span class="o">**</span><span class="n">cfg</span><span class="p">.</span><span class="n">datamodule</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">ModelModule</span><span class="p">(</span><span class="o">**</span><span class="n">cfg</span><span class="p">.</span><span class="n">model</span><span class="p">)</span>

        <span class="n">logger</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="n">loggers</span><span class="p">.</span><span class="n">tensorboard</span><span class="p">.</span><span class="n">TensorBoardLogger</span><span class="p">(</span><span class="o">**</span><span class="n">cfg</span><span class="p">.</span><span class="n">logger</span><span class="p">)</span>

        <span class="n">trainer</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="n">Trainer</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span> <span class="o">**</span><span class="n">cfg</span><span class="p">.</span><span class="n">trainer</span><span class="p">)</span>

        <span class="n">trainer</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">datamodule</span><span class="o">=</span><span class="n">dm</span><span class="p">)</span>
        <span class="n">trainer</span><span class="p">.</span><span class="n">test</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">datamodule</span><span class="o">=</span><span class="n">dm</span><span class="p">)</span>

    <span class="n">main</span><span class="p">()</span>
</pre></table></code></div></div><p>Ở đây, mình sử dụng một thư viện tên là <code class="language-plaintext highlighter-rouge">hydra</code> để quản lý các tinh chỉnh của tất cả thành phần trong code, như vậy khi huấn luyện sẽ không cần sửa code mà chỉ cần tinh chỉnh file configs là được.</p><p>Đây là file configs mẫu của mình. Bạn đọc có thể tinh chỉnh lại cho phù hợp với mỗi máy cá nhân.</p><pre><code class="language-YAML">datamodule:
  root: /kaggle/working/ # thư mục gốc để chứa dữ liệu sẽ được tải về
  batch_size: 128 # batch size của dataloader
  n_fft: 200 # số lượng fourier transform
  pin_memory: True # True if gpu

model:
  num_classes: 35 # số lượng lớp của dữ liệu
  dropout: 0.1 # tỉ lệ dropout
  lr: 0.001 # learning rate khởi tạo
  optim_configs:
    weight_decay: 0.0001

logger:
  save_dir: tb_logs # thư mục lưu log của tensorboard
  name: alexnet_logs # tên của log

trainer:
  max_epochs: 10 # số epoch tối đa 
  accelerator: auto # có thể là cpu, gpu, tpu. Auto sẽ tự lựa chọn dựa trên môi trường.
</code></pre><p>Bạn đọc có thể huấn luyện mô hình trên máy cá nhân hoặc Colab, đối với mình, mình sẽ huấn luyện trên Kaggle. Đây là link Kaggle mình sử dụng để config và train model này, bạn đọc có thể tham khảo <a href="https://www.kaggle.com/code/tuannguyenvananh/speech-commands-audio-classification" target="_blank">Kaggle</a>.</p><p><a name="-ket-qua"></a></p><h2 id="23-kết-quả">2.3. Kết quả</h2><p>Do Pytorch Lightning lưu kết quả để tiện theo dõi trong Tensorboard, nên ta có thể theo dõi thông qua nó.</p><p>Dưới đây là thông tin loss của tập dữ liệu train. Ta thấy loss giảm rất nhanh trong 1000, 2000 step đầu tiên, sau đó có thể learning rate vẫn hơi cao nên giao động loss xảy ra. Có lẽ chúng ta nên thêm một Learning Rate Scheduler vào mô hình, bạn đọc có thể thử nghiệm xem kết quả như thế nào. Nhưng tổng quan hình 4 thì ta thấy loss giảm, chứng tỏ mô hình đang học đúng hướng.</p><p> <img data-proofer-ignore data-src="/assets/audio_classification/train_loss.png" alt="train_loss" /> <em>Hình 4: Loss theo thời gian của mô hình trên tập dữ liệu train.</em></p><p>Dưới đây là thông tin loss của tập dữ liệu validate. Loss của tập validate cũng giảm nên ta cũng ngầm hiểu mô hình đang học đúng.</p><p> <img data-proofer-ignore data-src="/assets/audio_classification/val_loss.png" alt="val_loss" /> <em>Hình 5: Loss theo thời gian của mô hình trong quá trình validate.</em></p><p>Độ chính xác của tập dữ liệu validate. Ở đây, ta thấy độ chính xác (accuracy) tăng theo thời gian, chứng tỏ mô hình càng ngày càng cải thiện và mô hình học được tốt. Độ chính xác và loss cuối cùng của tập validate được thể hiện ở hình 7.</p><p> <img data-proofer-ignore data-src="/assets/audio_classification/val_acc.png" alt="val_acc" /> <em>Hình 6: Độ chính xác theo thời gian của mô hình trong quá trình validate</em></p><p> <img data-proofer-ignore data-src="/assets/audio_classification/final_metrics.png" alt="final_metrics" /> <em>Hình 7: Độ chính xác và loss cuối cùng của tập validate</em></p><p><a name="-tong-ket"></a></p><h1 id="3-tổng-kết">3. Tổng kết</h1><p>Bài viết này đã đi qua về định nghĩa bài toán nhận diện âm thanh và thực nghiệm trên bộ dữ liệu Speech Commands với mô hình AlexNet. Chúng ta thấy độ chính xác cuối cùng vào khoảng $73%$, không quá cao nhưng thể hiện được mô hình này có thể hoạt động tốt. Bạn đọc có thể thêm Learning Rate Scheduler, tinh chỉnh Optimizer, điều chỉnh learning rate, train thêm nhiều epoch và chỉnh sửa các thông tin khác để mô hình hoạt động tốt hơn.</p><p><strong>Bạn đọc có thể tham khảo thêm về:</strong></p><ul><li>Tổng hợp code của bài toán: <a href="https://github.com/tuanio/audio-classification" target="_blank">Audio Classification - Github</a>.<li>Code thực nghiệm mô hình: <a href="https://www.kaggle.com/code/tuannguyenvananh/speech-commands-audio-classification" target="_blank">Speech Commands Audio Classification - Kaggle</a>.</ul><p><a name="-tham-khao"></a></p><h1 id="4-tham-khảo">4. Tham khảo</h1><p><a name="-reference-1"></a> [1] Very Deep Convolutional Neural Networks For Raw Waveforms <a href="https://arxiv.org/pdf/1610.00087.pdf" target="_blank">https://arxiv.org/pdf/1610.00087.pdf</a>.</p><p><a name="-reference-2"></a> [2] ImageNet classification with deep convolutional neural networks <a href="https://dl.acm.org/doi/10.1145/3065386" target="_blank">https://dl.acm.org/doi/10.1145/3065386</a>.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/knowledge/'>knowledge</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/machine-learning/" class="post-tag no-text-decoration" >machine learning</a> <a href="/tags/audio-classification/" class="post-tag no-text-decoration" >audio classification</a> <a href="/tags/alexnet/" class="post-tag no-text-decoration" >alexnet</a> <a href="/tags/cnn/" class="post-tag no-text-decoration" >cnn</a> <a href="/tags/supervised-learning/" class="post-tag no-text-decoration" >supervised learning</a> <a href="/tags/speech-recognition/" class="post-tag no-text-decoration" >speech recognition</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Bài toán Audio Classification - tuanio&url=https://tuanio.github.io//posts/audio-classification/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Bài toán Audio Classification - tuanio&u=https://tuanio.github.io//posts/audio-classification/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Bài toán Audio Classification - tuanio&url=https://tuanio.github.io//posts/audio-classification/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/autorec/">AutoRec: Autoencoder dành cho Collaborative Filtering</a><li><a href="/posts/source-nlp/">Nguồn tài liệu để học NLP</a><li><a href="/posts/markov-chain-va-bai-toan-sang-nay-an-gi/">Markov Chain và bài toán 'Sáng nay ăn gì'</a><li><a href="/posts/minh-da-hoc-duoc-ghi-trong-nam-nay/">Mình đã học được gì trong năm nay?</a><li><a href="/posts/hidden-markov-model-and-sentiment-analysis/">Mô hình Markov ẩn và bài toán phân tích cảm xúc văn bản</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/machine-learning/">machine learning</a> <a class="post-tag" href="/tags/autoencoder/">autoencoder</a> <a class="post-tag" href="/tags/feedforward-neural-network/">feedforward neural network</a> <a class="post-tag" href="/tags/markov-process/">markov process</a> <a class="post-tag" href="/tags/nlp/">nlp</a> <a class="post-tag" href="/tags/probability/">probability</a> <a class="post-tag" href="/tags/supervised-learning/">supervised learning</a> <a class="post-tag" href="/tags/alexnet/">alexnet</a> <a class="post-tag" href="/tags/anomaly-detection/">anomaly detection</a> <a class="post-tag" href="/tags/audio-classification/">audio classification</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/autorec/"><div class="card-body"> <span class="timeago small" >Aug 5<i class="unloaded">2022-08-05T01:07:00+07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>AutoRec: Autoencoder dành cho Collaborative Filtering</h3><div class="text-muted small"><p> Nội dung 1. Hệ thống khuyến nghị và phương pháp Lọc cộng tác 2. Kiến trúc AutoRec 3. Thực nghiệm với bộ dữ liệu MovieLens 3.1 Chuẩn bị dữ liệu 3.2 Thiết kế mô hình ...</p></div></div></a></div><div class="card"> <a href="/posts/source-nlp/"><div class="card-body"> <span class="timeago small" >Dec 23, 2021<i class="unloaded">2021-12-23T15:11:00+07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Nguồn tài liệu để học NLP</h3><div class="text-muted small"><p> Bài viết này mang tính chất lưu trữ và chia sẻ. Những nguồn khi mới bắt đầu How to get started in nlp - medium Dữ liệu nlp-datasets - github Sách Deep Learning for NLP and Speech R...</p></div></div></a></div><div class="card"> <a href="/posts/markov-chain-va-bai-toan-sang-nay-an-gi/"><div class="card-body"> <span class="timeago small" >Dec 26, 2021<i class="unloaded">2021-12-26T21:35:00+07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Markov Chain và bài toán 'Sáng nay ăn gì'</h3><div class="text-muted small"><p> Nội dung 1. Định nghĩa Markov chain 2. Bài toán “sáng nay ăn gì” 3. Tổng kết Trong bài viết này, chúng ta sẽ đi qua sơ lược về định nghĩa của Markov chain, từ đó hiểu thêm về Markov chain ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/autoencoder/" class="btn btn-outline-primary" prompt="Older"><p>Autoencoder và bài toán phát hiện bất thường trong an ninh mạng</p></a> <a href="/posts/autorec/" class="btn btn-outline-primary" prompt="Newer"><p>AutoRec: Autoencoder dành cho Collaborative Filtering</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://github.com/tuanio">Nguyễn Văn Anh Tuấn</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/machine-learning/">machine learning</a> <a class="post-tag" href="/tags/autoencoder/">autoencoder</a> <a class="post-tag" href="/tags/feedforward-neural-network/">feedforward neural network</a> <a class="post-tag" href="/tags/markov-process/">markov process</a> <a class="post-tag" href="/tags/nlp/">nlp</a> <a class="post-tag" href="/tags/probability/">probability</a> <a class="post-tag" href="/tags/supervised-learning/">supervised learning</a> <a class="post-tag" href="/tags/alexnet/">alexnet</a> <a class="post-tag" href="/tags/anomaly-detection/">anomaly detection</a> <a class="post-tag" href="/tags/audio-classification/">audio classification</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-ZJYTV5L278"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-ZJYTV5L278'); }); </script>
